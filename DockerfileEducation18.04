FROM ubuntu:bionic-20180821

# change sh from, possibly, dash to bash
RUN cd /bin && rm sh && ln -s bash sh

# apt
RUN apt clean -y

RUN apt update -y

RUN DEBIAN_FRONTEND=noninteractive apt-get install -y \
	--no-install-recommends apt-utils

RUN DEBIAN_FRONTEND=noninteractive apt-get install -y \
	vim bash-completion sudo

# build-essential and other build/make package
RUN DEBIAN_FRONTEND=noninteractive apt-get install -y \
	build-essential make cmake cmake-curses-gui python3 \
	flex bison automake bc

# testing extras
RUN DEBIAN_FRONTEND=noninteractive apt-get install -y \
	cppcheck openjdk-11-jdk git gdb

# build-essential and other build/make package
RUN DEBIAN_FRONTEND=noninteractive apt-get install -y \
	iproute2 traceroute inetutils-ping dnsutils ssh lsb-core

# add docker repo from digital ocean
RUN DEBIAN_FRONTEND=noninteractive apt-get install -y \
	apt-transport-https ca-certificates curl software-properties-common

RUN curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -

RUN add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/$(. /etc/os-release; echo "$ID") $(lsb_release -cs) stable"

RUN apt update -y

# install docker-ce
RUN DEBIAN_FRONTEND=noninteractive apt-get install -y \
	docker-ce

# user setup
RUN useradd testuser -d /home/testuser -m -s /bin/bash &&\
 	passwd -d testuser &&\
	echo "testuser  ALL=(ALL)       NOPASSWD: ALL" >> /etc/sudoers; echo "Defaults    !requiretty" >> /etc/sudoers

RUN useradd ssher -d /home/ssher -m -s /bin/bash &&\
 	passwd -d ssher &&\
	echo "ssher  ALL=(ALL)       NOPASSWD: ALL" >> /etc/sudoers; echo "Defaults    !requiretty" >> /etc/sudoers

RUN echo "ssher:123Qwe" | chpasswd

RUN gpasswd -M testuser,ssher docker

RUN echo "DenyUsers testuer\nPermitRootLogin no" >> /etc/ssh/sshd_config

USER testuser

ENV EXPORT_DIR /export
VOLUME ["$EXPORT_DIR"]
WORKDIR $EXPORT_DIR

#ENTRYPOINT ["tail", "-f", "/dev/null"]
ENTRYPOINT sudo service ssh restart && bash

